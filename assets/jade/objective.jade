extends layouts/base
include mixins/_view_helpers

block vars
  - bodyClass = "objective"
  - pageTitle = "!Objective"

block content

  +modal("!Your writer's invitation", "invitation-modal/guidance-text-line-1", "func--invitation-guidance")
    p.invite-by-email
      span(data-l8n="content:invitation-modal/guidance-text-line-2") !To complete your invitation
      =" "
      a.button-link.clj-mail-to(href="mailto:###", data-l8n="content:invitation-modal/mail-to-text") !Send email
    .alternative-invite
      label.send-invite-label(for="copy-invite", data-l8n="content:invitation-modal/guidance-text-line-3") !Alternatively send the writer this link:
      input.invite-input-url.clj-invitation-url.func--invitation-url(id="copy-invite", type="text", value="!http://invitation/uuid/really/long/uuid")

  .intro-middle-container-wrapper
    .middle-container

      .clj-objective-progress-indicator
        +progressIndicator('objective',2)

      .objective-outline#details

        .objective-outline-header
          h1.objective-title.clj-objective-title.func--objective-page !Build safer cycling networks in the streets of Madrid.
          form.objective-star-container.clj-star-form(action="/meta/stars", method="post")
            input.clj-refer(type="hidden", value="!current-url", name="refer")
            input.clj-star-on-uri(type="hidden", value="!current-url", name="objective-uri")
            button.objective-star.clj-objective-star.func--objective-star(type="submit")
              i.fa.fa-star-o
              i.fa.fa-star

        h2(data-l8n="content:objective-view/details") !Details
        .objective-detail.clj-objective-detail
          p !London and Paris are two prime examples of cycle super highway heaven.  We need to show the world that madrid too can be the pinnacle in cycling and safety.
          p !Street art bitters pour-over, Portland pork belly master cleanse lumbersexual. Aesthetic 90's Shoreditch PBR. Austin sustainable Carles American Apparel, banh mi High Life selvage XOXO plaid stumptown fashion axe skateboard butcher McSweeney's. Master cleanse polaroid Shoreditch DIY, Godard salvia gastropub heirloom Kickstarter fap before they sold out chia. Disrupt Neutra tofu Godard kitsch. Chambray Helvetica plaid chia salvia. Cronut asymmetrical messenger bag, cornhole listicle selvage yr beard Godard stumptown meh sustainable.

      .latest-draft-wrapper.clj-latest-draft-wrapper
        .latest-draft.clj-latest-draft
          h2.latest-draft-title(data-l8n="content:objective-view/latest-draft") !Latest draft
          .latest-draft-item-list
            .latest-draft-item
              a.latest-draft-item-link.clj-latest-draft-link.func--latest-draft-link(href="/drafts/latest")
                .latest-draft-item-icon
                  i.fa.fa-file-text-o.latest-draft-item-icon-fa
                .latest-draft-item-text
                  span.latest-draft-item-writer.clj-latest-draft-writer !Prof Barry
                  = ", "
                  span.latest-draft-item-time.clj-latest-draft-time !2 days ago

  .middle-container

    .objective-navigation
      .objective-navigation-list-wrapper
        ul.objective-navigation-list.js-objective-nav
          li.objective-nav-top-link
            a(href="#top")
              i.fa.fa-arrow-circle-up
              .visuallyhidden(data-l8n="content:objective-nav/back-to-top") Back to top
          li
            a(href="#writers", data-l8n="content:objective-nav/writers") !Writers
          li
            a(href="#questions", data-l8n="content:objective-nav/questions") !Questions
          li
            a(href="#comments", data-l8n="content:objective-nav/comments") !Comments


    .objective-writers#writers
      h2(data-l8n="content:objective-view/writers") !Candidate writers
      ul.writer-item-list.clj-writer-item-list
        +writerItem('!Jenny Bloggs', '#', 'http://placekitten.com/g/80/80')
          | !A cycling enthusiast, responsible for many safety policies in the UK.
        +writerItem('!Boris Johnson', '#', 'http://placekitten.com/g/81/81')
          | !Quirky but has achieved wonders in the London for the boris bikes.
        +writerItem('!Bob Smith', '#', '')
          | !Interested in anything to do with cycling and Spain.
      a.button.invite-writer.clj-invite-writer-link.func--invite-writer(href="/objective-invite-writer", data-l8n="content:objective-view/invite-a-writer") !Invite a writer
      a.button.clj-writer-dashboard-link.func--writer-dashboard-link(href="/objective/dashboard", data-l8n="content:writer-dashboard/link-button") !Dashboard

    #questions
      .objective-questions-guidance
        h2.objective-questions-guidance-title(data-l8n="content:objective-view/question-section-title") !Help to turn this objective into a policy
        ul.objective-questions-guidance-list
          li.objective-questions-guidance-list-item(data-l8n="content:objective-view/question-how-it-works-1") !A policy starts with an objective
          li.objective-questions-guidance-list-item(data-l8n="content:objective-view/question-how-it-works-2") !Questions provide evidence for the policy
          li.objective-questions-guidance-list-item(data-l8n="content:objective-view/question-how-it-works-3") !Anyone can answer a question and agree or disagree with an answer
          li.objective-questions-guidance-list-item(data-l8n="content:objective-view/question-how-it-works-4") !The answers will be used by the writers when drafting the policy
      .objective-questions
        h2(data-l8n="content:objective-view/objective-questions-title") !Questions
        p(data-l8n="content:objective-view/objective-questions-helper-text") !These questions have been chosen by the writers because the results are important to the objective.
        ol.question-list.clj-objective-question-list
          +questionItemWithDemoteForm('!Chris Cheshire', '3 September 2015 07:41')
            | !What road surface should we use?
          +questionItemWithDemoteForm('!Chris Cheshire', '4 September 2015 07:41')
            | !Do we have a colour in mind for the road?
          +questionItemWithDemoteForm('!Chris Cheshire', '4 September 2015 08:41')
            | !What do we do if we have a really long question which will wrap across multiple lines?

      .objective-questions
        h2(data-l8n="content:objective-view/community-questions-title") !Questions from the community
        p(data-l8n="content:objective-view/community-questions-helper-text") !These questions have been suggested by the community. The answers may be useful for drafting the policy.
        ol.question-list.clj-community-question-list
          +questionItemWithPromoteForm('!Chris Cheshire', '3 September 2015 07:41')
            | !What road surface should we use?
          +questionItemWithPromoteForm('!Chris Cheshire', '4 September 2015 07:41')
            | !Do we have a colour in mind for the road?
          +questionItemWithPromoteForm('!Chris Cheshire', '4 September 2015 07:41')
            | !What do we do if we have a really long question which will wrap across multiple lines?
        a.button.clj-ask-question-link.func--add-question(href="/objective-write-a-question", data-l8n="content:objective-view/ask-a-question") !Ask a question

    .objective-comments#comments
      h2(data-l8n="content:objective-view/comments") !Comments for this objective
      ol.comment-list.clj-comment-list
        li.comment-item
          .comment-meta
            span.comment-author Joe Blogs
            span.comment-date 4 September 2015 15:41
          .comment-text
            p !We definitely need to look into Gran Via and Calle Mayor!
          +commentReply

          ol.comment-list
            li.comment-item
              .comment-meta
                span.comment-author Matt Smith
                span.comment-date 4 September 2015 16:21
              .comment-text
                p !Agreed.  This would be a good location.
              +commentReply

              ol.comment-list
                +commentItem('George Maison', '4 September 2015 16:25')
                  p I was thinking this too!
                +commentItem('Mike Cruise', '4 September 2015 16:55')
                  p Sounds goood!
                li.more-comments-item
                  a.more-comments-item-link(href="#") More comments

        +commentItem('Phil Smith', '2 September 2015 07:41')
          p !Oooh Paseo del Prado.
        +commentItem('Jen Bloggs', '1 September 2015 07:41')
          p !Paseo del Prado.

        li.comment-history-item.clj-comment-history-item
          a.comment-history-item-link.clj-comment-history-link(href="!comment-history-url", data-l8n="content:objective-view/comment-history") !More comments

      .clj-comment-create
        +addCommentForm()

block footerScripts
  script.
    // temp
    $(document).ready(function () {
      var pageNav = $('.objective-navigation-list-wrapper');
      var pageNavStickHeight = pageNav.offset().top;
      var pageNavHeight = pageNav.height();
      $(window).scroll(function () {
        if ($(this).scrollTop() > pageNavStickHeight) {
          pageNav.addClass("sticky");
        }
        else {
          pageNav.removeClass("sticky");
        }
      });

      function closeModal() {
        $(this).parentsUntil($('.js-close-target').parent()).addClass('js-hidden');
      }

      var closeWriterInvitation = $('.js-close');
      closeWriterInvitation.click(closeModal);

      /* TODO - factor out */
      var modalContent = $('.js-modal-content');
      if (modalContent.length) { //disabled
        var modal = $('.js-modal');
        modalContent.addClass('js-modal-fix-up');
        $('.js-modal-container').append(modalContent);
        modal.removeClass('js-hidden');
      }

      var yNavSpacer = 20;
      $('.js-objective-nav a').click(function(evn){
          evn.preventDefault();
          var xPos = $(this.hash).position().left;
          var yPos = $(this.hash).position().top;
          var yPosWithoutHeader = yPos - (pageNavHeight + yNavSpacer);
          $('html,body').scrollTo(xPos, yPosWithoutHeader);
      });

      var pageNavChildren = $(".js-objective-nav li").children();
      var pageNavList = [];
      var pageNavActiveClass = "on"
      for (var i=0; i < pageNavChildren.length; i++) {
        var aChild = pageNavChildren[i];
        var ahref = $(aChild).attr('href');
        pageNavList.push(ahref);
      }

      $(window).scroll(function(){
        var windowPos = $(window).scrollTop();
        var windowHeight = $(window).height();
        var docHeight = $(document).height();

        for (var i=0; i < pageNavList.length; i++) {
          var theID = pageNavList[i];
          var divPos = $(theID).offset().top - (yNavSpacer + pageNavHeight + 1);
          var divHeight = $(theID).height();
          if (windowPos >= divPos && windowPos < (divPos + divHeight)) {
            $("a[href='" + theID + "']").addClass(pageNavActiveClass);
          } else {
            $("a[href='" + theID + "']").removeClass(pageNavActiveClass);
          }
        }

        if(windowPos + windowHeight == docHeight) {
          if (!$(".js-objective-nav li:last-child a").hasClass(pageNavActiveClass)) {
            $(".js-objective-nav li a").removeClass(pageNavActiveClass);
            $(".js-objective-nav li:last-child a").addClass(pageNavActiveClass);
          }
        }
      });

    });



